# GAME RULES - Pirate Dice

> **개발 가이드 참조**: 이 규칙을 코드로 구현할 때는 [CLAUDE.md](./CLAUDE.md) 문서의 코딩 규칙을 따르세요.

---

## 1. 기본 구성 요소

### 1.1 플레이어 자원

각 플레이어는 다음을 가진다:
- 주사위 컵 1개
- 주사위 N개 (노란색 = HP + 베팅 자원)

**초기 주사위 수 (플레이어 수에 따라):**

| 플레이어 수 | 초기 주사위 |
|------------|------------|
| 2인 | 15개 |
| 3인 | 10개 |
| 4인 | 7개 |
| 5인 | 6개 |
| 6인 | 5개 |

### 1.2 게임판 구성

- 중앙에 총 30칸의 빈 공간 (버린 주사위 보관 영역)
- 주변에 베팅 칸
- '1' 주사위 칸에 빨간 주사위(눈 1) 1개 배치 (와일드카드 역할, 섹션 10 참조)

### 1.3 플레이 순서 결정

1. 각자 자신의 주사위를 굴린다
2. 눈 수가 큰 사람 순서대로 배치
3. 동수 발생 시, 남은 눈 중 가장 큰 숫자가 높은 순서

> **전략적 의미**: 플레이어 위치(양 옆의 성향)에 따라 전략이 달라질 수 있음

---

## 2. 용어 정의

| 용어 | 정의 |
|------|------|
| 주사위 눈 | 1~6의 숫자 |
| 베팅 (Bet) | "특정 숫자 X의 주사위가 Y개 이상 존재한다"는 주장 |
| 도전 (Challenge) | 이전 플레이어의 베팅이 거짓이라고 판정하고 공개를 요구하는 행동 |
| 와일드카드 | 모든 숫자로 카운트되는 특수 주사위 (빨간 주사위 1) |

---

## 3. 게임 진행 흐름

### 3.1 라운드 시작

1. 모든 플레이어는 자신의 남아있는 주사위를 굴린다
2. 주사위 결과는 자기만 확인한다 (비공개)
3. 라운드 첫 베팅자 결정:
   - 전 라운드에서 도전한 사람이 첫 베팅자
   - 해당 플레이어가 탈락했다면 다음 순서의 플레이어가 시작

### 3.2 턴 진행

```
[첫 베팅자] → 베팅 → [다음 플레이어] → 베팅 또는 도전 → ...
                                              ↓
                               도전 발생 시 → 판정 → 라운드 종료
```

---

## 4. 플레이어 행동 규칙

각 플레이어의 턴에는 **두 가지 행동만 가능**:

| 행동 | 설명 | 조건 |
|------|------|------|
| 베팅 | 새로운 베팅을 선언 | 항상 가능 |
| 도전 (블러프 선언) | 이전 베팅에 대해 공개 요구 | 첫 플레이어 제외 |

> **중요**: 라운드의 첫 플레이어는 베팅만 가능

---

## 5. 베팅 규칙 상세

### 5.1 베팅 문장 형태

```
"(숫자 X)가 (개수 Y)개 이상 존재한다"
```

예시: "4가 5개 이상 존재한다"

### 5.2 베팅 규칙 원칙

#### (1) 개수 하락 금지
- 이전 베팅보다 개수(Y)를 낮출 수 없음
- 항상 Y 이상이어야 함

#### (2) 개수를 올릴 때 → X 자유
- Y를 올리면 X는 임의로 변경 가능
- 예: "4가 6개 이상" → "1이 7개 이상" (O)

#### (3) 개수를 유지할 때 → X 증가 필수
- Y를 유지하면 X는 반드시 증가해야 함
- 예: "4가 5개" → "5가 5개" (O)
- 예: "4가 5개" → "2가 5개" (X - 불가능)

### 5.3 베팅 검증 로직 (개발자용)

```typescript
function isValidBet(previousBet: Bet, newBet: Bet): boolean {
  // 첫 베팅인 경우 항상 유효
  if (!previousBet) return true;

  // 규칙 1: 개수 하락 금지
  if (newBet.count < previousBet.count) return false;

  // 규칙 2: 개수 증가 시 X 자유
  if (newBet.count > previousBet.count) return true;

  // 규칙 3: 개수 유지 시 X 증가 필수
  return newBet.value > previousBet.value;
}
```

---

## 6. 도전 (블러프 선언) 규칙

### 6.1 도전 조건
- 이전 플레이어의 베팅이 불가능해 보인다고 판단될 때

### 6.2 도전 발생 시 절차
1. 모든 플레이어가 주사위를 공개한다
2. 베팅된 눈(X)의 실제 개수를 합산한다
3. 와일드카드(빨간 주사위 1) 포함 여부 확인 (섹션 10 참조)
4. 판정 결과에 따라 처리

---

## 7. 도전 결과 판정 로직

**판정 기준**: 실제 개수 R, 베팅 개수 Y

| 조건 | 결과 | 패널티 |
|------|------|--------|
| R > Y | 베팅 성공 / 도전 실패 | 도전자가 (R - Y)개 주사위 손실 |
| R < Y | 베팅 실패 / 도전 성공 | 베팅자가 (Y - R)개 주사위 손실 |
| R = Y | 베팅 성공 / 도전 실패 | 베팅자 제외 모든 플레이어가 1개씩 손실 |

> 잃은 주사위는 중앙 버린 칸에 배치

### 7.1 판정 로직 (개발자용)

```typescript
interface ChallengeResult {
  winner: 'bettor' | 'challenger';
  loserPlayerId: string | string[];  // R=Y 시 배열
  diceToLose: number;
  actualCount: number;
  bettedCount: number;
}

function judgeChallenge(
  allDice: Map<string, number[]>,
  bet: Bet,
  challengerId: string
): ChallengeResult {
  // 실제 개수 계산 (와일드카드 포함)
  const actualCount = countDiceWithWildcard(allDice, bet.value);
  const diff = actualCount - bet.count;

  if (diff > 0) {
    // R > Y: 도전자 패배
    return {
      winner: 'bettor',
      loserPlayerId: challengerId,
      diceToLose: diff,
      actualCount,
      bettedCount: bet.count
    };
  } else if (diff < 0) {
    // R < Y: 베팅자 패배
    return {
      winner: 'challenger',
      loserPlayerId: bet.playerId,
      diceToLose: Math.abs(diff),
      actualCount,
      bettedCount: bet.count
    };
  } else {
    // R = Y: 베팅자 제외 모두 1개 손실
    return {
      winner: 'bettor',
      loserPlayerId: getAllPlayersExcept(bet.playerId),
      diceToLose: 1,
      actualCount,
      bettedCount: bet.count
    };
  }
}
```

---

## 8. 라운드 종료 및 다음 라운드

1. 도전 판정이 끝나면 라운드를 종료한다
2. 모든 플레이어는 주사위를 다시 굴린다
3. 다음 라운드를 시작한다

**다음 라운드 첫 베팅자 결정:**
- 도전을 선언한 플레이어가 다음 라운드 첫 베팅자
- 단, 해당 플레이어가 탈락한 경우:
  - 탈락자의 다음 순서 플레이어가 첫 베팅자

---

## 9. 탈락 및 승리 조건

### 9.1 탈락
- 주사위가 0개가 되는 즉시 탈락
- 탈락한 플레이어는 이후 라운드에 참여 불가

### 9.2 승리
- 마지막까지 살아남은 플레이어 1명이 승리
- 승리 조건: 생존 플레이어가 1명만 남음

---

## 10. 특수 규칙: 빨간 주사위 (와일드카드)

### 10.1 개요
- 게임 시작 시 '1' 주사위 칸에 빨간 주사위(눈 1) 1개가 배치됨
- 이 주사위는 **와일드카드** 역할을 함

### 10.2 와일드카드 규칙
- 빨간 주사위(1)는 모든 숫자(1~6)로 카운트됨
- 판정 시 실제 개수 계산에 포함됨

**예시:**
- 베팅: "4가 5개 이상"
- 실제 주사위: 4가 4개 + 빨간 1이 1개 = 총 5개로 계산
- 결과: 베팅 성공

### 10.3 와일드카드 카운팅 로직 (개발자용)

```typescript
function countDiceWithWildcard(
  allDice: Map<string, number[]>,
  targetValue: number
): number {
  let count = 0;

  for (const playerDice of allDice.values()) {
    for (const dice of playerDice) {
      // 타겟 값과 일치하거나 와일드카드(1)인 경우
      if (dice === targetValue || dice === 1) {
        count++;
      }
    }
  }

  // 중앙의 빨간 주사위도 와일드카드로 포함
  count += 1; // 빨간 주사위 1개

  return count;
}
```

> **주의**: 타겟 값이 1인 경우에도 빨간 주사위는 1개만 카운트됨 (중복 카운트 방지)

---

## 11. 게임 상태 다이어그램

```
                    ┌─────────────────┐
                    │   게임 대기      │
                    │  (플레이어 입장)  │
                    └────────┬────────┘
                             │ 최소 2명 + 모두 준비
                             ▼
                    ┌─────────────────┐
                    │   순서 결정      │
                    │  (주사위 굴림)   │
                    └────────┬────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │         라운드 시작           │◄──────────────┐
              │  (모든 플레이어 주사위 굴림)   │               │
              └──────────────┬───────────────┘               │
                             │                               │
                             ▼                               │
              ┌──────────────────────────────┐               │
              │          베팅 턴             │               │
              │  (베팅 또는 도전 선택)        │←─────┐       │
              └──────────────┬───────────────┘      │       │
                             │                      │       │
              ┌──────────────┴──────────────┐      │       │
              │                             │      │       │
              ▼                             ▼      │       │
      ┌──────────────┐            ┌──────────────┐│       │
      │    베팅      │            │    도전      ││       │
      │ (다음 턴으로) │────────────│ (판정 진행)  ││       │
      └──────────────┘            └──────┬───────┘│       │
                                         │        │       │
                                         ▼        │       │
                                  ┌──────────────┐│       │
                                  │   판정 처리   ││       │
                                  │ (주사위 손실) ││       │
                                  └──────┬───────┘│       │
                                         │        │       │
                          ┌──────────────┴──────────────┐ │
                          │                             │ │
                          ▼                             ▼ │
                  ┌──────────────┐            ┌──────────────┐
                  │ 생존자 1명   │            │ 생존자 2명+  │
                  │  → 게임 종료 │            │  → 다음 라운드│
                  └──────────────┘            └──────────────┘
```

---

## 12. 엣지 케이스 및 예외 처리

### 12.1 동시 탈락
- 판정 결과로 여러 플레이어가 동시에 0개가 되는 경우
- 모두 동시 탈락 처리
- 생존자가 1명 이상이면 게임 계속

### 12.2 모든 플레이어 탈락
- 극히 드문 경우지만, R = Y 상황에서 베팅자 제외 모두 탈락 시
- 베팅자가 자동 승리

### 12.3 연결 끊김
- 플레이어 연결이 끊긴 경우 일정 시간 대기 후 자동 패배 처리
- 또는 AI 대체 여부를 다른 플레이어에게 투표

### 12.4 턴 타임아웃
- 일정 시간 내 행동하지 않으면 자동으로 최소 베팅 수행
- 타임아웃 시간은 설정으로 조절 가능

---

## 13. 구현 체크리스트

> 개발 시 아래 항목들이 모두 구현되었는지 확인

- [ ] 플레이어 수에 따른 초기 주사위 배분
- [ ] 순서 결정 로직 (주사위 굴림, 동점 처리)
- [ ] 베팅 유효성 검증 (개수 하락 금지, X 증가 규칙)
- [ ] 도전 판정 로직 (R > Y, R < Y, R = Y 케이스)
- [ ] 와일드카드 카운팅
- [ ] 주사위 손실 처리 및 탈락 판정
- [ ] 다음 라운드 첫 베팅자 결정
- [ ] 승리 조건 확인
- [ ] 엣지 케이스 처리 (동시 탈락, 타임아웃 등)
